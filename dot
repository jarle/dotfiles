#!/usr/bin/env bash

set -e

# Change to dir of script
cd "$(dirname "$0")"

# Useful variables
BASEDIR="$(pwd)"
BACKUPDIR="$BASEDIR/.backup"

MAIN_APPLICATIONS="git tmux curl base-devel zsh cmake autoconf python-pip clang xclip fish cmus xbindkeys"
YAOURT_APPLICATIONS="silver-searcher-git universal-ctags-git neovim-qt-git fontconfig-infinality fontconfig-infinality"

sudo -v
rm -rf $BACKUPDIR
mkdir -p $BACKUPDIR
if [[ ! "$SHELL" == "/usr/bin/fish" ]]; then
    echo nofish
    chsh -s /usr/bin/fish
fi

# Install main applications
sudo pacman -S --noconfirm --needed $MAIN_APPLICATIONS
yaourt -S --noconfirm --needed $YAOURT_APPLICATIONS
sudo -H pip install ptpython neovim

# Set up symlinks
for file in $(find . -name '*.symlink'); do
	filename="$HOME/.$(basename $file .symlink)"
	# create backup if the file already exists
	if [ -e $filename ]; then
		mv $filename $BACKUPDIR
	fi
	ln -s $BASEDIR/$file $filename
done

git config --global core.excludesfile "$HOME/.gitignore"
mkdir -p $HOME/.config/nvim/autoload
if [ ! -f ~/.config/nvim/autoload/plug.vim ]; then
	curl -fLo ~/.config/nvim/autoload/plug.vim --create-dirs \
		    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
fi

ln -s --force $HOME/.vimrc $HOME/.config/nvim/init.vim
nvim +PlugInstall +PlugClean +qall

printf "Done!\n"
printf "Old files has been put in $BACKUPDIR\n"
